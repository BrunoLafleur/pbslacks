#! /bin/sh

# Auteur : Pierre Brochard (pierre.brochard.1982@m4x.org)
# Date : 2019
# License : See the LICENSE file in this repository.

# Recompilations a faire apres reboot.

. "$(dirname $0)/pbinclude"

if [ ! $UID = 0 ]; then
    mygt 'This script must be done as root. Exit.'
    exit 1
fi

xhelp () {
    mygt 'Launch this script in the directory including packages, packages2 et al.'
}

if [ ! -d packages -o ! -d packages2 -o ! -d packages3 -o ! -d packages4 ] ;then
    xhelp
    exit 1
fi

MYUSER=produits
MYGROUP=users
RECOMP=1

while [ $# -ge 1 ] ;do
    MYARG="$1"
    if [ "$MYARG" = "-u" ] ;then
	shift
	MYUSER="$1"
    elif [ "$MYARG" = "-g" ] ;then
	shift
	MYGROUP="$1"
    elif [ "$MYARG" = "-norecomp" ] ;then
        RECOMP=0
    elif [ "$MYARG" = "-help" -o "$MYARG" = "-h" ] ;then
	xhelp
	exit 0
    fi
    shift
done

mygt 'Only after a system update and reboot.\nIf already done on this or another machine, this script is not useful.\nPress a touch for continue or abort.'|sed 's@\\n@\n@g'
read c

xpurgetmp () {
    pac="$1"
    rm -f /tmp/"${pac}-"*.t?z
    rm -rf /tmp/"${pac}-"*
    rm -rf /tmp/*/"${pac}-"*
    rm -rf /tmp/package-"$pac"
    rm -rf /tmp/*/package-"$pac"
}

xmakealienpac () {
    XDIR="$1"
    pac="$2"
    dest="$3"
    [ -z "$dest" ] && dest="$XDIR"
    if [ $RECOMP -eq 1 -a -d "${XDIR}/$pac" ] ;then
	(
	    cd "${XDIR}/$pac"
	    sh "./${pac}.SlackBuild"
	    if [ $? -ne 0 ] ;then
		mygt 'Correct this error and relaunch this script.'
		exit 1
	    fi
	)
	cp "/tmp/${pac}-"*.t?z "$dest"
	chown ${MYUSER}.$MYGROUP "$dest/${pac}"-*.t?z
	xpurgetmp "$pac"
        upgradepkg --install-new --reinstall "$dest/${pac}"-*.t?z
    fi
}

xmakepac () {
    XDIR="$1"
    XPAC="$2"
    XSUB="$3"

    if [ $RECOMP -eq 1 ] ;then
	(
	    cd ${XDIR}/$XPAC
	    tar xvfz ${XPAC}.t*gz
	    if [ -d "$XPAC" ] ;then
		(
		    cd $XPAC;ln -sf ../* .;rm -f $XPAC ${XPAC}.tar.gz
		    ./${XPAC}.SlackBuild
		    if [ $? -ne 0 ] ;then
			mygt 'Correct this error and relaunch this script.'
			exit 1
		    fi
		)
		rm -rf $XPAC
	    fi
	)
	cp /tmp/${XPAC}-*.t?z $XDIR
	chown ${MYUSER}.$MYGROUP $XDIR/${XPAC}-*.t?z
	xpurgetmp $XPAC
	if [ "$XSUB" != '' ] ;then
            mv $XDIR/${XPAC}-*i486*.t?z $XDIR/$XSUB
	fi
    fi
    if [ "$XSUB" = '' ] ;then
	upgradepkg --install-new --reinstall $XDIR/${XPAC}-*.t?z
	rm -f /usr/lib64/lib*.la
    fi
}

rm -f /usr/lib64/lib*.la

# python2-* for openshot 1.4
for i in python2-mlt python2-libcaca python2-libwebp openal-soft \
		     libtxc_dxtn libgaminggear python-pillow6 acpibrightness \
		     python3-certifi openshot_qt ;do
    xmakepac packages $i
done
rm -rf packages/python-pillow

# mlt python3 recompiled with new libs.
export BUILD=3alien
xmakealienpac packages mlt

# 32 bits packages
export ARCH=i486
for i in openal-soft libtxc_dxtn ;do
    xmakepac packages $i 32
done
unset ARCH

(
    cd packages/32
    for i in cabextract libdvdcss icoutils wxPython openal-soft libtxc_dxtn ;do
	if [ $RECOMP -eq 1 ] ;then
	    convertpkg-compat32 -i "$i-"'*.t?z' -d ../compat32
	    chown ${MYUSER}.$MYGROUP ../compat32/$i-compat32-*.t?z
	fi
	xpurgetmp ${i}-compat32
	upgradepkg --install-new --reinstall ../compat32/$i-compat32-*.t?z
	rm -f /usr/lib/lib*.la
    done
)

# More 64 bits packages
for i in roccat-tools kmplayer denemo guile2.2 ;do
    xmakepac packages2 $i
done
for i in bsddb3 db53 pyicu gramps ;do
    xmakepac packages3 $i
done
for i in xrdp xorgxrdp SFML wxGTK3 vbam fbida kaffeine opencv gradle \
	      signal-desktop audiveris zoom-linux ;do
    xmakepac packages4 $i
done

# Recompile and reinstall some Slackware packages for new dependencies.
export X264=yes
export X265=yes
export OPENAL=yes
xmakealienpac source/l ffmpeg packages

mygt "Upgrade packages* done."
