#! /bin/sh

# Auteur : Pierre Brochard (pierre.brochard.1982@m4x.org)
# Date : 2019
# License : See the LICENSE file in this repository.

if [ ! -d packages ] ;then
    echo "Script a lancer dans le repertoire contenant packages, packages2 et al."
    echo "Launch this script in the directory including packages, packages2 et al."
    exit 1
fi

# Sources packages.
PATHDENEMO="http://git.savannah.gnu.org/cgit/denemo.git/snapshot/denemo-master.tar.gz"
PATHGRAMPS="https://github.com/gramps-project/gramps/archive/v5.1.1.zip"
PATHOPENAL="https://www.openal-soft.org/openal-releases/openal-soft-1.20.0.tar.bz2"
PATHLIBTXC_DXTN="https://people.freedesktop.org/~cbrill/libtxc_dxtn/libtxc_dxtn-1.0.1.tar.bz2"
PATHLIBGAMINGGEAR="https://downloads.sourceforge.net/libgaminggear/libgaminggear-0.15.1.tar.bz2"
PATHROCCATTOOLS="https://downloads.sourceforge.net/roccat/roccat-tools-5.9.0.tar.bz2"
PATHKMPLAYER="https://anongit.kde.org/kmplayer.git"
PATHBSDDB3="https://files.pythonhosted.org/packages/e9/fc/ebfbd4de236b493f9ece156f816c21df0ae87ccc22604c5f9b664efef1b9/bsddb3-6.2.6.tar.gz"
PATHDB53="http://deb.debian.org/debian/pool/main/d/db5.3/db5.3_5.3.28+dfsg1.orig.tar.xz"
PATHDB53BIS="http://deb.debian.org/debian/pool/main/d/db5.3/db5.3_5.3.28+dfsg1-0.6.debian.tar.xz"
PATHPYICU="https://pypi.python.org/packages/a2/9f/1947f288143191b903e58633ee597cb98bc284de28dafb1231b6f8b67b99/PyICU-1.9.5.tar.gz"
PATHXRDP="https://github.com/neutrinolabs/xrdp/releases/download/v0.9.12/xrdp-0.9.12.tar.gz"
PATHXORGXRDP="https://github.com/neutrinolabs/xorgxrdp/releases/download/v0.2.12/xorgxrdp-0.2.12.tar.gz"
PATHSFML="https://www.sfml-dev.org/files/SFML-2.5.1-sources.zip"
PATHWXGTK3="https://github.com/wxWidgets/wxWidgets/archive/v3.0.4/wxWidgets-3.0.4.tar.gz"
PATHVBAM="https://github.com/visualboyadvance-m/visualboyadvance-m/archive/v2.1.4/visualboyadvance-m-2.1.4.tar.gz"
PATHFBIDA="https://www.kraxel.org/releases/fbida/fbida-2.14.tar.gz"
PATHKAFFEINE="https://github.com/KDE/kaffeine/archive/master.zip"
PATHOPENCV="https://github.com/opencv/opencv/archive/4.1.1/opencv-4.1.1.tar.gz"
PATHOPENCVBIS="https://github.com/opencv/opencv_contrib/archive/4.1.1/opencv_contrib-4.1.1.tar.gz"

# Binary packages.
SLACKCF="http://slack.conraid.net/repository/slackware64-current"
SLACKDJ="http://www.slackel.gr/repo/x86_64/current/slackel/extra"
SLACKDJ32="http://www.slackel.gr/repo/i486/current/slackel/extra"

xpurgepac () {
    pac="$1"
    last=`ls -1t "$pac"*.t?z|head -1`
    for j in "$pac"*.t?z ;do
	if [ "$j" != "$last" ] ;then
	    rm -f "$j"
	fi
    done
}

xgetpac () {
    pac="$1"
    dir="$2"
    prof="$3"
    wget -N -A "$pac"'*.t?z' -r -nv -np -nH --cut-dir=$prof "$dir/"
    xpurgepac "$pac"
}

xgetsrcpac () {
    name="$1"
    path="$2"
    localcopie=`echo "$path"|cut -d ':' -f1`
    if [ ! -d "$name" ] ;then
        mkdir "$name"
        cp "../pbslacks/builds/${name}.tar.gz" "$name"
    fi
    if [ "$localcopie" = http -o "$localcopie" = https ] ;then
        cd "$name"
        wget -N -nv --content-disposition "$path"
	cd ..
    else
	echo "Copie locale de ../pbslacks/builds/$path vers $name"
	cp "../pbslacks/builds/$path" "$name"
    fi
}

# Download new sources.
cd packages
xgetsrcpac OpenAL "$PATHOPENAL"
xgetsrcpac libtxc_dxtn "$PATHLIBTXC_DXTN"
xgetsrcpac libgaminggear "$PATHLIBGAMINGGEAR"
cd ..

cd packages2
xgetsrcpac roccat-tools "$PATHROCCATTOOLS"
xgetsrcpac kmplayer "kmplayer_0.11.5b.tar.bz2"
xgetsrcpac denemo "$PATHDENEMO"
cd ..

cd packages3
xgetsrcpac bsddb3 "$PATHBSDDB3"
xgetsrcpac db53 "$PATHDB53"
xgetsrcpac db53 "$PATHDB53BIS"
xgetsrcpac pyicu "$PATHPYICU"
xgetsrcpac gramps "$PATHGRAMPS"
cd ..

cd packages4
xgetsrcpac xrdp "$PATHXRDP"
xgetsrcpac xorgxrdp "$PATHXORGXRDP"
xgetsrcpac SFML "$PATHSFML"
xgetsrcpac wxGTK3 "$PATHWXTK3"
xgetsrcpac vbam "$PATHVBAM"
xgetsrcpac fbida "$PATHFBIDA"
xgetsrcpac kaffeine "$PATHKAFFEINE"
xgetsrcpac opencv "$PATHOPENCV"
xgetsrcpac opencv "$PATHOPENCVBIS"
cd ..

# Download new versions of binary packages.
cd packages
for i in gimp-script-fu x265 ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in frei0r-plugins libvdpau-va-gl openshot ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
cd 32
for i in wxPython ;do
    xgetpac "$i-" "$SLACKDJ32" 5
done
cd ../..
find packages -name 'index.html*' -exec rm -f {} \;

cd packages2
for i in jq lua oniguruma valgrind ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in guile1.8 ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
cd ..
find packages2 -name 'index.html*' -exec rm -f {} \;

cd packages4
for i in exiftools ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in xcftools ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
if [ ! -d tesseract4 ] ;then
    mkdir tesseract4
fi
cd tesseract4
for i in leptonica tesseract ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
cd ../..
cp pbslacks/tesseract4/* packages4/tesseract4
find packages4 -name 'index.html*' -exec rm -f {} \;
