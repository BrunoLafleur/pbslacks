#! /bin/sh

# Auteur : Pierre Brochard (pierre.brochard.1982@m4x.org)
# Date : 2019

if [ ! -d packages ] ;then
    echo "Script a lancer dans le repertoire contenant packages, packages2 et al."
    exit 1
fi

PATHDENEMO="http://git.savannah.gnu.org/cgit/denemo.git/snapshot/denemo-master.tar.gz"
PATHGRAMPS="https://github.com/gramps-project/gramps/archive/v5.1.1.zip"
PATHOPENAL="https://www.openal-soft.org/openal-releases/openal-soft-1.20.0.tar.bz2"
PATHLIBTXC_DXTN="https://people.freedesktop.org/~cbrill/libtxc_dxtn/libtxc_dxtn-1.0.1.tar.bz2"
PATHLIBGAMINGGEAR="https://downloads.sourceforge.net/libgaminggear/libgaminggear-0.15.1.tar.bz2"
PATHROCCATTOOLS="https://downloads.sourceforge.net/roccat/roccat-tools-5.9.0.tar.bz2"
PATHKMPLAYER="https://anongit.kde.org/kmplayer.git"

SLACKCF="http://slack.conraid.net/repository/slackware64-current"
SLACKDJ="http://www.slackel.gr/repo/x86_64/current/slackel/extra"
SLACKDJ32="http://www.slackel.gr/repo/i486/current/slackel/extra"

xpurgepac () {
    pac="$1"
    LAST=`ls -1t "$pac"*.t?z|head -1`
    for j in "$pac"*.t?z ;do
	if [ "$j" != "$LAST" ] ;then
	    rm -f "$j"
	fi
    done
}

xgetpac () {
    pac="$1"
    dir="$2"
    prof="$3"
    wget -N -A "$pac"'*.t?z' -r -np -nH --cut-dir=$prof "$dir/"
    xpurgepac "$pac"
}

xgetsrcpac () {
    name="$1"
    path="$2"
    localcopie=`echo "$path"|cut -d ':' -f1`
    if [ ! -d "$name" ] ;then
        mkdir "$name"
        cp "../pbslacks/builds/${name}.tar.gz" "$name"
    fi
    if [ "$localcopie" = http -o "$localcopie" = https ] ;then
        cd "$name"
        wget -N "$path"
	cd ..
    else
	cp "../pbslacks/builds/$path" "$name"
    fi
    xpurgepac "$name-"
}

# Download new sources.
cd packages
xgetsrcpac OpenAL "$PATHOPENAL"
xgetsrcpac libtxc_dxtn "$PATHLIBTXC_DXTN"
xgetsrcpac libgaminggear "$PATHLIBGAMINGGEAR"
cd ../..

cd packages2
xgetsrcpac roccat-tools "$ROCCATTOOLS"
xgetsrcpac kmplayer "kmplayer_0.11.3d.tar.bz2"
xgetsrcpac denemo "$PATHDENEMO"
cd ../..

cd packages3
xgetsrcpac bsddb3 "toto"
xgetsrcpac db53 "toto"
xgetsrcpac pyicu "toto"
xgetsrcpac gramps "$PATHGRAMPS"
cd ../..

cd packages4
xgetsrcpac xrdp "toto"
xgetsrcpac xorgxrdp "toto"
xgetsrcpac SFML "toto"
xgetsrcpac wxGTK3 "toto"
xgetsrcpac vbam "toto"
xgetsrcpac fbida "toto"
xgetsrcpac kaffeine "toto"
xgetsrcpac opencv "toto"
cd ../..

# Download new versions of binary packages.
cd packages
for i in gimp-script-fu x265 ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in frei0r-plugins libvdpau-va-gl openshot ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
cd 32
for i in wxPython ;do
    xgetpac "$i-" "$SLACKDJ32" 5
done
cd ../..
find packages -name 'index.html*' -exec rm -f {} \;

cd packages2
for i in jq lua oniguruma valgrind ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in guile1.8 ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
cd ..
find packages2 -name 'index.html*' -exec rm -f {} \;

cd packages4
for i in exiftools ;do
    xgetpac "$i-" "$SLACKCF/$i" 3
done
for i in xcftools ;do
    xgetpac "$i-" "$SLACKDJ" 5
done
cd ..
find packages4 -name 'index.html*' -exec rm -f {} \;
