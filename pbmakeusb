#! /bin/sh

# Auteur : Pierre Brochard (pierre.brochard.1982@m4x.org)
# Date : 2019
# License : See the LICENSE file in this repository.

# Use at your own risk. The autodetected partition is the last VFAT one.
# Be sure it is not your hard drive.

# Plug an USB stick
# And lauch this script without plug another one in the meantime.
# This script will :
#   -guess the device name of the USB stick.
#   -reformat the partition given for the USB stick (or answer ynof below).
#   -put the current slackware local tree on it (without the source packages).

# Or put an ISO Slackware image on the USB stick (better than uses pbmakeiso2usb
# because the resulting USB stick is writable and keep her original size).

# You can launch this script as a normal user in the plugdev group.
# Use fdisk and udisksctl.

if [ ! $UID = 0 ]; then
  cat << EOF
This script must be run as root.
EOF
  exit 1
fi

xhelp () {
    cat <<EOF
Script a lancer dans le repertoire contenant slackware64-current fraichement aspire.
Launch this script in the directory including slackware64-current.

> pbslacks/pbmakeusb [-iso slack.iso] [-gpart gparted.iso] [-noudisks2]
                     [-noslack (no packages copy on the stick)]
EOF
}

MYPWD=$(pwd)
ISO=0
REPO="$MYPWD/slackware64-current"
GPARTISO=
NOUDISKS2=
FULLINSTALLER=1

while [ $# -ge 1 ] ;do
    MYARG="$1"
    shift
    if [ "$MYARG" = "-noudisks2" ] ;then
	NOUDISKS2='-noudisks2'
    elif [ "$MYARG" = "-noslack" ] ;then
	FULLINSTALLER=0
    elif [ "$MYARG" = "-help" -o "$MYARG" = "-h" ] ;then
	xhelp
	exit 0
    elif [ "$MYARG" = "-iso" ] ;then
	IMGISO="$1"
	if [ "$IMGISO" != '' ] ;then
	    BIMG=$(basename "$IMGISO")
	    BIMGISO=$(basename "$IMGISO" .iso)
	    if [ "$BIMG" != "$BIMGISO" ] ;then
		ISO=1
	    fi
	fi
	shift
    elif [ "$MYARG" = "-gpart" ] ;then
	GPARTISO="$1"
	RELP=$(echo "$GPARTISO"|cut -c1)
	[ "$RELP" = '.' ] && GPARTISO="$MYPWD/$GPARTISO"
	GPARTISO="-gpart $GPARTISO"
	shift
    fi
done

if [ ! -d slackware64-current -a $ISO -eq 0 ] ;then
    xhelp
    exit 1
fi

if [ $ISO -eq 1 ] ;then
    if [ "$NOUDISKS2" != '' ] ;then
	XLOOP=$(losetup -f);losetup $XLOOP "$IMGISO"
	REPO=$(mktemp -p /tmp -t pbmakeusb.XXXXXX)
	mount -t vfat "${XLOOP}p1" "$REPO"
    else
	XLOOP=$(udisksctl loop-setup -f "$IMGISO"|sed 's@^.* \(.*\)\.$@\1@')
	REPO=$(udisksctl mount -b "${XLOOP}p1"|cut -d ' ' -f4-|\
	    sed 's@^\(.*\)\.$@\1@')
    fi
    cat <<EOF
For the iso $IMGISO :
  The loop device is : $XLOOP
  The mount dir is : $REPO
EOF
fi

cd "$REPO"
if [ $? -ne 0 ] ;then
    echo "Repertoire non existant."
    echo "Is your ISO file a Slackware image ?"
    exit 1
fi

echo "Put your writable USB stick on an USB port and press Enter."
echo "It will be erased and replaced by a bootable Slackware installation media."
read c

sleep 3
MYDEVNAME=$(/sbin/fdisk -l 2> /dev/null| tail -1 | grep 'FAT32$'|\
    cut -d ' ' -f1|cut -d '1' -f1)

if [ "$MYDEVNAME" = '' ] ;then
# If it is an already created Slackware USB stick."
    MYDEVNAME=$(/sbin/fdisk -l 2> /dev/null| tail -3 | grep 'EFI '|\
	cut -d ' ' -f1|cut -d '2' -f1)
fi

/sbin/fdisk -l 2> /dev/null
echo "The device name for your writable erasable USB stick is $MYDEVNAME."
echo "Is this correct ? y(es) or n(o) or ynof(ormat) :"
read c

if [ "$c" = 'ynof' ] ;then
    c=y
    FORMAT=
else
    FORMAT=-f
fi

if [ $FULLINSTALLER -eq 1 ]; then
    OPTREPO='-s '"$REPO"
else
    OPTREPO=
fi

if [ "$c" = 'y' -a "$MYDEVNAME" != '' ] ;then
    cd usb-and-pxe-installers
    "$MYPWD/pbslacks/pbimg2disk" $FORMAT -i $(pwd)/usbboot.img \
	-o "$MYDEVNAME" $OPTREPO $NOUDISKS2 $GPARTISO
fi

if [ $ISO -eq 1 ] ;then
    cd "$MYPWD"
    if [ "$NOUDISKS2" != '' ] ;then
	[ ! -z "$REPO" ] && (umount "${XLOOP}p1";losetup -d $XLOOP;rmdir "$REPO")
    else
	udisksctl unmount -b "${XLOOP}p1"
	udisksctl loop-delete -b "$XLOOP"
    fi
fi
